<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Central Trade Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="js/firebase-database.js"></script>
</head>
<body>
    <!-- Navigation Header -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-left">
                <a href="#" class="logo">Central Trade Hub</a>
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Search markets, assets...">
                </div>
            </div>
            <div class="nav-right">
                <button class="nav-btn" onclick="showNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>
                <button class="nav-btn" onclick="openMessages()">
                    <i class="fas fa-envelope"></i>
                </button>
                <div class="user-menu">
                    <span class="user-email" id="userEmail">Loading...</span>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-content">
            <div class="menu-section">
                <h3 class="menu-title">Trading</h3>
                <ul class="menu-list">
                    <li><a href="#" class="menu-link active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                    <li><a href="platform.html" class="menu-link"><i class="fas fa-chart-bar"></i> Trading Platform</a></li>
                    <li><a href="#" class="menu-link"><i class="fas fa-history"></i> Trade History</a></li>
                </ul>
            </div>
            <div class="menu-section">
                <h3 class="menu-title">Account</h3>
                <ul class="menu-list">
                    <li><a href="funding.html" class="menu-link"><i class="fas fa-wallet"></i> Funding</a></li>
                    <li><a href="profile.html" class="menu-link"><i class="fas fa-user"></i> Profile</a></li>
                    <li><a href="#" class="menu-link"><i class="fas fa-cog"></i> Settings</a></li>
                </ul>
            </div>
            <div class="market-status">
                <div class="status-indicator">
                    <span class="status-dot active"></span>
                    <span class="status-text">Markets Open</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-header">
            <h1 class="page-title">Dashboard</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="refreshBalance()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-grid">
            <div class="summary-card">
                <div class="card-header">
                    <h3 class="card-title">Account Balance</h3>
                    <i class="fas fa-wallet card-icon"></i>
                </div>
                <div class="card-content">
                    <div class="balance-amount" id="accountBalance">$0.00</div>
                    <div class="balance-change positive" id="balanceChange">+$0.00 (0.0%)</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="card-header">
                    <h3 class="card-title">Equity</h3>
                    <i class="fas fa-chart-line card-icon"></i>
                </div>
                <div class="card-content">
                    <div class="balance-amount" id="accountEquity">$0.00</div>
                    <div class="balance-change" id="equityChange">$0.00 (0.0%)</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="card-header">
                    <h3 class="card-title">Free Margin</h3>
                    <i class="fas fa-shield-alt card-icon"></i>
                </div>
                <div class="card-content">
                    <div class="balance-amount" id="freeMargin">$0.00</div>
                    <div class="balance-info" id="marginLevel">Margin Level: 0%</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="card-header">
                    <h3 class="card-title">Today's P&L</h3>
                    <i class="fas fa-chart-area card-icon"></i>
                </div>
                <div class="card-content">
                    <div class="balance-amount" id="todayPnL">$0.00</div>
                    <div class="balance-info">Daily Performance</div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="showDeposit()">
                <i class="fas fa-plus"></i> Deposit Funds
            </button>
            <button class="btn btn-secondary" onclick="showWithdraw()">
                <i class="fas fa-minus"></i> Withdraw Funds
            </button>
            <button class="btn btn-secondary" onclick="window.location.href='platform.html'">
                <i class="fas fa-chart-line"></i> Start Trading
            </button>
        </div>

        <!-- Market Overview -->
        <div class="content-section">
            <div class="section-header">
                <h2 class="section-title">Market Overview</h2>
                <button class="btn btn-sm" onclick="updateMarketData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="market-grid">
                <div class="market-card">
                    <div class="market-header">
                        <span class="market-symbol">EUR/USD</span>
                        <span class="market-change positive">+0.12%</span>
                    </div>
                    <div class="market-price">1.0845</div>
                    <div class="market-info">
                        <span class="market-high">H: 1.0867</span>
                        <span class="market-low">L: 1.0823</span>
                    </div>
                </div>
                <div class="market-card">
                    <div class="market-header">
                        <span class="market-symbol">GBP/USD</span>
                        <span class="market-change negative">-0.08%</span>
                    </div>
                    <div class="market-price">1.2634</div>
                    <div class="market-info">
                        <span class="market-high">H: 1.2658</span>
                        <span class="market-low">L: 1.2612</span>
                    </div>
                </div>
                <div class="market-card">
                    <div class="market-header">
                        <span class="market-symbol">USD/JPY</span>
                        <span class="market-change positive">+0.34%</span>
                    </div>
                    <div class="market-price">149.87</div>
                    <div class="market-info">
                        <span class="market-high">H: 150.12</span>
                        <span class="market-low">L: 149.45</span>
                    </div>
                </div>
                <div class="market-card">
                    <div class="market-header">
                        <span class="market-symbol">Gold</span>
                        <span class="market-change positive">+0.67%</span>
                    </div>
                    <div class="market-price">2034.50</div>
                    <div class="market-info">
                        <span class="market-high">H: 2038.20</span>
                        <span class="market-low">L: 2029.80</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="content-section">
            <div class="section-header">
                <h2 class="section-title">Recent Activity</h2>
                <a href="#" class="section-link">View All</a>
            </div>
            <div class="activity-table">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>2024-01-15</td>
                            <td>Deposit</td>
                            <td class="positive">+$1,000.00</td>
                            <td><span class="status-badge success">Completed</span></td>
                        </tr>
                        <tr>
                            <td>2024-01-14</td>
                            <td>Trade</td>
                            <td class="positive">+$45.67</td>
                            <td><span class="status-badge success">Closed</span></td>
                        </tr>
                        <tr>
                            <td>2024-01-13</td>
                            <td>Trade</td>
                            <td class="negative">-$23.45</td>
                            <td><span class="status-badge success">Closed</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="js/dashboard.js"></script>
    <script>
        // Firebase Authentication Check
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('userEmail').textContent = user.email;
                loadUserBalance();
                setupBalanceListener();
            } else {
                window.location.href = 'auth.html';
            }
        });

        // Load User Balance
        async function loadUserBalance() {
            try {
                const user = firebase.auth().currentUser;
                if (!user) return;

                const result = await FirebaseDatabaseService.getUserBalance(user.uid);
                if (result.success) {
                    document.getElementById('accountBalance').textContent = 
                        formatCurrency(result.balance || 0);
                } else {
                    console.error('Failed to load balance:', result.error);
                }
            } catch (error) {
                console.error('Error loading balance:', error);
            }
        }

        // Setup Real-time Balance Listener
        function setupBalanceListener() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const userDoc = firebase.firestore().collection('users').doc(user.uid);
            
            userDoc.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    const balance = data.accountBalance || 0;
                    document.getElementById('accountBalance').textContent = formatCurrency(balance);
                    
                    // Update other fields if they exist
                    if (data.equity !== undefined) {
                        const equityElement = document.getElementById('accountEquity');
                        if (equityElement) equityElement.textContent = formatCurrency(data.equity);
                    }
                    
                    if (data.freeMargin !== undefined) {
                        const marginElement = document.getElementById('freeMargin');
                        if (marginElement) marginElement.textContent = formatCurrency(data.freeMargin);
                    }
                    
                    if (data.todayPnL !== undefined) {
                        const pnlElement = document.getElementById('todayPnL');
                        if (pnlElement) {
                            pnlElement.textContent = formatCurrency(data.todayPnL);
                            pnlElement.className = `balance-amount ${data.todayPnL >= 0 ? 'positive' : 'negative'}`;
                        }
                    }
                }
            });
        }

        // Format Currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        // Refresh Balance
        async function refreshBalance() {
            const refreshBtn = document.querySelector('.btn i.fa-sync-alt');
            if (refreshBtn) {
                refreshBtn.classList.add('fa-spin');
            }
            
            await loadUserBalance();
            
            setTimeout(() => {
                if (refreshBtn) {
                    refreshBtn.classList.remove('fa-spin');
                }
            }, 1000);
        }

        // Navigation Functions
        function showDeposit() {
            window.location.href = 'funding.html';
        }

        function showWithdraw() {
            window.location.href = 'funding.html#withdraw';
        }

        // Logout Function
        async function logout() {
            try {
                await firebase.auth().signOut();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'index.html';
            }
        }

        // Market Data Updates (Simulated)
        function updateMarketData() {
            const marketPrices = document.querySelectorAll('.market-price');
            marketPrices.forEach(priceElement => {
                const currentPrice = parseFloat(priceElement.textContent);
                const change = (Math.random() - 0.5) * 0.001;
                const newPrice = currentPrice + change;
                priceElement.textContent = newPrice.toFixed(4);
            });
        }

        // Notification and Message Functions
        function showNotifications() {
            alert('Notifications feature coming soon!');
        }

        function openMessages() {
            alert('Messages feature coming soon!');
        }

        // Update market data every 3 seconds
        setInterval(updateMarketData, 3000);
    </script>
</body>
</html>