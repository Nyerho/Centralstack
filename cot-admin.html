<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COT Management - Central Trade Hub Admin</title>
    <link rel="stylesheet" href="css/admin.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Admin Header -->
    <header class="admin-header">
        <div class="admin-nav">
            <div class="admin-logo">
                <i class="fas fa-shield-alt"></i>
                <span>COT Management - Central Trade Hub</span>
            </div>
            <div class="admin-user">
                <a href="admin.html?from=cot-admin" class="btn-secondary"><i class="fas fa-arrow-left"></i> Back to Admin</a>
                <span>Welcome, Admin</span>
                <a href="#" class="btn-logout" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </header>

    <div class="admin-container">
        <!-- Main Content -->
        <main class="admin-main" style="margin-left: 0; padding: 30px;">
            <!-- COT Management Section -->
            <section class="admin-section active">
                <div class="section-header">
                    <h1><i class="fas fa-shield-alt"></i> Withdrawal COT Management</h1>
                    <p>Manage the Withdrawal Code (COT) required for user withdrawals</p>
                </div>

                <div class="cot-management-content">
                    <div class="cot-form">
                        <div class="form-group">
                            <label for="current-cot-code">Current COT Code</label>
                            <div class="input-group">
                                <input type="text" id="current-cot-code" readonly class="form-control monospace">
                                <button id="copy-cot-btn" onclick="copyCotCode()" class="btn-secondary">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="new-cot-code">New COT Code</label>
                            <input type="text" id="new-cot-code" placeholder="Enter new COT code" maxlength="20" class="form-control">
                        </div>

                        <div class="button-group">
                            <button id="update-cot-code" onclick="updateCotCode()" class="btn-primary">
                                <i class="fas fa-save"></i> Update COT Code
                            </button>
                            <button id="generate-random-cot" onclick="generateRandomCot()" class="btn-secondary">
                                <i class="fas fa-random"></i> Generate Random
                            </button>
                        </div>

                        <div id="cot-status" class="status-message">
                            <!-- Status messages will appear here -->
                        </div>
                    </div>

                    <div class="cot-info">
                        <h4>COT Code Information</h4>
                        <div class="info-item">
                            <strong>Last Updated:</strong>
                            <span id="cot-last-updated">Never</span>
                        </div>
                        <div class="info-item">
                            <strong>Updated By:</strong>
                            <span id="cot-updated-by">N/A</span>
                        </div>
                    </div>

                    <div class="cot-instructions">
                        <h4>Instructions</h4>
                        <ul>
                            <li>The COT code is required for all user withdrawals</li>
                            <li>Users must contact support to obtain the current COT code</li>
                            <li>Change the COT code regularly for security</li>
                            <li>Use the "Generate Random" button for secure codes</li>
                            <li>COT codes must be at least 4 characters long</li>
                        </ul>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Scripts -->
    <script type="module" src="js/firebase-config.js"></script>
    <script type="module" src="js/firebase-auth.js"></script>
    <script type="module" src="js/firebase-database.js"></script>
    <script type="module" src="js/auth-integration.js"></script>
    <script type="module" src="js/cot-management.js"></script>

    <script type="module">
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('Starting COT admin page initialization...');
                
                // Wait for auth manager with proper initialization check
                let attempts = 0;
                while ((!window.authManager || !window.authManager.isInitialized) && attempts < 100) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.authManager) {
                    throw new Error('Authentication system not available');
                }
                
                // Initialize AuthManager if not already initialized
                if (!window.authManager.isInitialized) {
                    await window.authManager.initialize();
                }
                
                // Wait for authentication state to be determined
                await new Promise(resolve => {
                    const checkAuth = () => {
                        if (window.authManager.getCurrentUser() !== undefined) {
                            resolve();
                        } else {
                            setTimeout(checkAuth, 100);
                        }
                    };
                    checkAuth();
                });
                
                // Check authentication and admin status
                const user = window.authManager.getCurrentUser();
                if (!user) {
                    alert('Please log in to access COT management.');
                    window.location.href = 'auth.html';
                    return;
                }
                
                const isAdmin = await window.authManager.checkAdminStatus();
                if (!isAdmin) {
                    alert('Access denied. Admin privileges required.');
                    window.location.href = 'dashboard.html';
                    return;
                }
                
                // Make database available globally
                window.db = (await import('./js/firebase-config.js')).db;
                window.currentUser = user;
                
                // Load COT settings
                if (typeof window.loadCurrentCotCode === 'function') {
                    await window.loadCurrentCotCode();
                }
                
                console.log('COT admin page initialized successfully');
                
            } catch (error) {
                console.error('COT admin initialization error:', error);
                alert('Failed to initialize COT management: ' + error.message);
                window.location.href = 'admin.html';
            }
        });

        // Logout function
        window.handleLogout = async function() {
            try {
                if (window.authManager) {
                    await window.authManager.logout();
                }
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'auth.html';
            }
        };

        // Toast notification function
        window.showToast = function(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        };
    </script>

    <style>
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background-color: #28a745;
        }
        
        .toast.error {
            background-color: #dc3545;
        }
        
        .toast.info {
            background-color: #17a2b8;
        }
        
        .cot-instructions {
            margin-top: 30px;
            padding: 20px;
            background: #2d2d2d;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .cot-instructions h4 {
            margin-bottom: 15px;
            color: #007bff;
        }
        
        .cot-instructions ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .cot-instructions li {
            margin-bottom: 8px;
            color: #ccc;
        }
    </style>
</body>
</html>