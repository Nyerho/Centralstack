<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYC Verification Portal - Mirror Trade</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/kyc-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation Header -->
    <header class="kyc-header">
        <div class="container">
            <div class="header-content">
                <button class="back-btn" onclick="window.location.href='dashboard.html'">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Dashboard</span>
                </button>
                <div class="header-title">
                    <h1>KYC Verification</h1>
                    <p>Secure your account with identity verification</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="kyc-main">
        <div class="container">
            <!-- KYC Status Card -->
            <div class="kyc-status-card">
                <div class="status-header">
                    <div class="status-icon" id="statusIcon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="status-info">
                        <h2 id="statusTitle">Verification Pending</h2>
                        <p id="statusDescription">Complete your KYC verification to unlock all features</p>
                    </div>
                    <div class="status-badge" id="statusBadge">
                        <span class="badge pending">Pending</span>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-steps">
                        <div class="step" id="step1">
                            <div class="step-circle">1</div>
                            <span>Personal Info</span>
                        </div>
                        <div class="step" id="step2">
                            <div class="step-circle">2</div>
                            <span>Document Upload</span>
                        </div>
                        <div class="step" id="step3">
                            <div class="step-circle">3</div>
                            <span>Verification</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Benefits Section -->
            <div class="benefits-section">
                <h3><i class="fas fa-star"></i> Benefits of KYC Verification</h3>
                <div class="benefits-grid">
                    <div class="benefit-item">
                        <div class="benefit-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="benefit-content">
                            <h4>Enhanced Security</h4>
                            <p>Protect your account with verified identity</p>
                        </div>
                    </div>
                    <div class="benefit-item">
                        <div class="benefit-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="benefit-content">
                            <h4>Higher Limits</h4>
                            <p>Increase your trading and withdrawal limits</p>
                        </div>
                    </div>
                    <div class="benefit-item">
                        <div class="benefit-icon">
                            <i class="fas fa-rocket"></i>
                        </div>
                        <div class="benefit-content">
                            <h4>Premium Features</h4>
                            <p>Access advanced trading tools and features</p>
                        </div>
                    </div>
                    <div class="benefit-item">
                        <div class="benefit-icon">
                            <i class="fas fa-headset"></i>
                        </div>
                        <div class="benefit-content">
                            <h4>Priority Support</h4>
                            <p>Get faster customer support response</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Requirements Section -->
            <div class="requirements-section">
                <h3><i class="fas fa-list-check"></i> Required Documents</h3>
                <div class="requirements-list">
                    <div class="requirement-item">
                        <div class="requirement-icon">
                            <i class="fas fa-id-card"></i>
                        </div>
                        <div class="requirement-content">
                            <h4>Government-issued ID</h4>
                            <p>Passport, Driver's License, or National ID Card</p>
                        </div>
                        <div class="requirement-status" id="docStatus1">
                            <i class="fas fa-clock text-warning"></i>
                        </div>
                    </div>
                    <div class="requirement-item">
                        <div class="requirement-icon">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                        <div class="requirement-content">
                            <h4>Proof of Address</h4>
                            <p>Utility bill, Bank statement (not older than 3 months)</p>
                        </div>
                        <div class="requirement-status" id="docStatus2">
                            <i class="fas fa-clock text-warning"></i>
                        </div>
                    </div>
                    <div class="requirement-item">
                        <div class="requirement-icon">
                            <i class="fas fa-camera"></i>
                        </div>
                        <div class="requirement-content">
                            <h4>Selfie Verification</h4>
                            <p>Clear photo of yourself holding your ID document</p>
                        </div>
                        <div class="requirement-status" id="docStatus3">
                            <i class="fas fa-clock text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-section">
                <div class="action-buttons">
                    <button class="btn btn-primary btn-large" id="startVerificationBtn" onclick="startKYCVerification()">
                        <i class="fas fa-play"></i>
                        <span>Start Verification</span>
                    </button>
                    <button class="btn btn-secondary" id="continueVerificationBtn" onclick="continueKYCVerification()" style="display: none;">
                        <i class="fas fa-arrow-right"></i>
                        <span>Continue Verification</span>
                    </button>
                    <button class="btn btn-outline" onclick="window.location.href='dashboard.html'">
                        <i class="fas fa-home"></i>
                        <span>Go to Dashboard</span>
                    </button>
                </div>
                
                <div class="help-section">
                    <p><i class="fas fa-info-circle"></i> Need help? Contact our <a href="#" onclick="openSupportChat()">support team</a></p>
                </div>
            </div>

            <!-- Verification Modal -->
            <div class="modal" id="verificationModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>KYC Verification Process</h3>
                        <button class="modal-close" onclick="closeVerificationModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="verification-steps">
                            <div class="step-content" id="stepContent">
                                <!-- Dynamic content will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Processing your verification...</p>
        </div>
    </div>

  
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAwnWoLfrEc1EtXWCD0by5L0VtCmYf8Unw",
            authDomain: "centraltradehub-30f00.firebaseapp.com",
            projectId: "centraltradehub-30f00",
            storageBucket: "centraltradehub-30f00.firebasestorage.app",
            messagingSenderId: "745751687877",
            appId: "1:745751687877:web:4576449aa2e8360931b6ac"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global variables
        let currentUser = null;
        let uploadedFiles = {
            id: null,
            bill: null,
            selfie: null
        };
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    currentUser = user;
                    loadKYCStatus();
                } else {
                    window.location.href = 'auth.html';
                }
            });
        });
        
        // Load KYC status
        async function loadKYCStatus() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    updateStatusDisplay(userData.kycStatus || 'not_started');
                }
            } catch (error) {
                console.error('Error loading KYC status:', error);
                updateStatusDisplay('not_started');
            }
        }
        
        // Update status display
        function updateStatusDisplay(status) {
            const statusElement = document.querySelector('.status-badge');
            const progressBar = document.querySelector('.progress-fill');
            const startBtn = document.getElementById('startVerificationBtn');
            const continueBtn = document.getElementById('continueVerificationBtn');
            
            switch(status) {
                case 'verified':
                    statusElement.textContent = 'Verified';
                    statusElement.className = 'status-badge verified';
                    progressBar.style.width = '100%';
                    startBtn.style.display = 'none';
                    continueBtn.style.display = 'none';
                    break;
                case 'pending':
                    statusElement.textContent = 'Under Review';
                    statusElement.className = 'status-badge pending';
                    progressBar.style.width = '66%';
                    startBtn.style.display = 'none';
                    continueBtn.style.display = 'inline-flex';
                    break;
                case 'rejected':
                    statusElement.textContent = 'Rejected';
                    statusElement.className = 'status-badge rejected';
                    progressBar.style.width = '33%';
                    startBtn.style.display = 'inline-flex';
                    continueBtn.style.display = 'none';
                    break;
                default:
                    statusElement.textContent = 'Not Started';
                    statusElement.className = 'status-badge not-started';
                    progressBar.style.width = '0%';
                    startBtn.style.display = 'inline-flex';
                    continueBtn.style.display = 'none';
            }
        }
        
        // Start KYC Verification
        function startKYCVerification() {
            const modal = document.getElementById('verificationModal');
            const stepContent = document.getElementById('stepContent');
            
            stepContent.innerHTML = `
                <div class="verification-form">
                    <h4>Upload Required Documents</h4>
                    <p class="form-description">Please upload clear, high-quality images of your documents</p>
                    
                    <!-- ID Document Upload -->
                    <div class="upload-section">
                        <div class="upload-header">
                            <i class="fas fa-id-card"></i>
                            <h5>Government-issued ID</h5>
                            <span class="required">*Required</span>
                        </div>
                        <div class="upload-area" id="idUploadArea">
                            <input type="file" id="idFileInput" accept="image/*,.pdf" style="display: none;">
                            <div class="upload-placeholder" onclick="document.getElementById('idFileInput').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Click to upload or drag and drop</p>
                                <small>Supported: JPG, PNG, PDF (Max 5MB)</small>
                            </div>
                            <div class="upload-preview" id="idPreview" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Utility Bill Upload -->
                    <div class="upload-section">
                        <div class="upload-header">
                            <i class="fas fa-file-invoice"></i>
                            <h5>Proof of Address</h5>
                            <span class="required">*Required</span>
                        </div>
                        <div class="upload-area" id="billUploadArea">
                            <input type="file" id="billFileInput" accept="image/*,.pdf" style="display: none;">
                            <div class="upload-placeholder" onclick="document.getElementById('billFileInput').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Click to upload or drag and drop</p>
                                <small>Utility bill, bank statement (Max 5MB)</small>
                            </div>
                            <div class="upload-preview" id="billPreview" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Selfie Upload -->
                    <div class="upload-section">
                        <div class="upload-header">
                            <i class="fas fa-camera"></i>
                            <h5>Selfie with ID</h5>
                            <span class="required">*Required</span>
                        </div>
                        <div class="upload-area" id="selfieUploadArea">
                            <input type="file" id="selfieFileInput" accept="image/*" style="display: none;">
                            <div class="upload-placeholder" onclick="document.getElementById('selfieFileInput').click()">
                                <i class="fas fa-camera"></i>
                                <p>Take a selfie or upload photo</p>
                                <small>Hold your ID next to your face (Max 5MB)</small>
                            </div>
                            <div class="upload-preview" id="selfiePreview" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="closeVerificationModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="btn btn-primary" id="submitVerificationBtn" onclick="submitVerification()" disabled>
                            <i class="fas fa-check"></i> Submit for Review
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
            initializeFileUploads();
        }
        
        // Initialize file uploads
        function initializeFileUploads() {
            const fileInputs = ['idFileInput', 'billFileInput', 'selfieFileInput'];
            const previews = ['idPreview', 'billPreview', 'selfiePreview'];
            const areas = ['idUploadArea', 'billUploadArea', 'selfieUploadArea'];
            const types = ['id', 'bill', 'selfie'];
            
            fileInputs.forEach((inputId, index) => {
                const input = document.getElementById(inputId);
                const preview = document.getElementById(previews[index]);
                const area = document.getElementById(areas[index]);
                const type = types[index];
                
                if (input && preview && area) {
                    input.addEventListener('change', (e) => {
                        handleFileUpload(e, preview, area, type);
                    });
                    
                    // Drag and drop
                    area.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        area.classList.add('drag-over');
                    });
                    
                    area.addEventListener('dragleave', () => {
                        area.classList.remove('drag-over');
                    });
                    
                    area.addEventListener('drop', (e) => {
                        e.preventDefault();
                        area.classList.remove('drag-over');
                        
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            input.files = files;
                            handleFileUpload({ target: input }, preview, area, type);
                        }
                    });
                }
            });
        }
        
        // Handle file upload
        function handleFileUpload(event, preview, area, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }
            
            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
            if (!allowedTypes.includes(file.type)) {
                alert('Please upload a valid image (JPG, PNG) or PDF file');
                return;
            }
            
            // Store file
            uploadedFiles[type] = file;
            
            // Show preview
            const placeholder = area.querySelector('.upload-placeholder');
            placeholder.style.display = 'none';
            preview.style.display = 'block';
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.innerHTML = `
                        <div class="file-preview">
                            <img src="${e.target.result}" alt="Preview" style="max-width: 200px; max-height: 150px; border-radius: 8px;">
                            <div class="file-info">
                                <p><strong>${file.name}</strong></p>
                                <p>${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                <button class="btn-remove" onclick="removeFile('${type}')">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = `
                    <div class="file-preview">
                        <div class="pdf-icon">
                            <i class="fas fa-file-pdf" style="font-size: 3rem; color: #dc3545;"></i>
                        </div>
                        <div class="file-info">
                            <p><strong>${file.name}</strong></p>
                            <p>${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                            <button class="btn-remove" onclick="removeFile('${type}')">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                `;
            }
            
            checkSubmitButton();
        }
        
        // Remove file
        function removeFile(type) {
            uploadedFiles[type] = null;
            
            const inputId = type + 'FileInput';
            const previewId = type + 'Preview';
            const areaId = type + 'UploadArea';
            
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const area = document.getElementById(areaId);
            const placeholder = area.querySelector('.upload-placeholder');
            
            if (input) input.value = '';
            if (preview) preview.style.display = 'none';
            if (placeholder) placeholder.style.display = 'block';
            
            checkSubmitButton();
        }
        
        // Check submit button
        function checkSubmitButton() {
            const submitBtn = document.getElementById('submitVerificationBtn');
            
            if (uploadedFiles.id && uploadedFiles.bill && uploadedFiles.selfie && submitBtn) {
                submitBtn.disabled = false;
                submitBtn.classList.add('btn-ready');
            } else if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.classList.remove('btn-ready');
            }
        }
        
        // Submit verification
        async function submitVerification() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'block';
            
            try {
                // Simulate upload process
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Update user status
                await db.collection('users').doc(currentUser.uid).update({
                    kycStatus: 'pending',
                    kycSubmittedAt: new Date().toISOString(),
                    documentsUploaded: {
                        id: uploadedFiles.id.name,
                        proofOfAddress: uploadedFiles.bill.name,
                        selfie: uploadedFiles.selfie.name
                    }
                });
                
                closeVerificationModal();
                loadKYCStatus();
                
                alert('Documents submitted successfully! We will review your verification within 24-48 hours.');
                
            } catch (error) {
                console.error('Error submitting verification:', error);
                alert('Failed to submit documents. Please try again.');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        // Close modal
        function closeVerificationModal() {
            const modal = document.getElementById('verificationModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Continue verification
        function continueKYCVerification() {
            alert('Your verification is currently under review. You will receive an email notification once the review is complete.');
        }
        
        // Support chat
        function openSupportChat() {
            alert('Support chat would open here. Please contact support@centraltradekeplr.com for assistance.');
        }
    </script>
</body>
</html>